name: 同步 Scoop CTF 仓库

on:
  schedule:
    # 每天北京时间早上8点运行 (UTC时间0点)
    - cron: '0 0 * * *'
  push:
    # 当工作流文件本身被修改时触发
    paths:
      - '.github/workflows/sync-buckets.yml'
  workflow_dispatch:
    # 允许手动触发
    inputs:
      bucket:
        description: '指定要同步的仓库（留空表示同步所有）'
        required: false
        default: ''

env:
  TZ: Asia/Shanghai

jobs:
  sync-buckets:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      max-parallel: 1  # 一次只运行一个job，避免并发推送冲突
      matrix:
        bucket:
          - name: sec
            repo: tldro/scoop-security
          - name: ar
            repo: arch3rPro/PST-Bucket
          - name: ctftools
            repo: kengwang/scoop-ctftools-bucket
    
    steps:
    - name: 检出代码库
      if: github.event.inputs.bucket == '' || github.event.inputs.bucket == matrix.bucket.name
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: 设置 Git
      if: github.event.inputs.bucket == '' || github.event.inputs.bucket == matrix.bucket.name
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"

    - name: 同步仓库内容
      if: github.event.inputs.bucket == '' || github.event.inputs.bucket == matrix.bucket.name
      run: |
        echo "正在同步 ${{ matrix.bucket.name }} (repo: ${{ matrix.bucket.repo }})..."
        
        # 创建目标目录
        TARGET_DIR="buckets/${{ matrix.bucket.name }}"
        SCRIPTS_DIR="scripts"
        mkdir -p "$TARGET_DIR"
        mkdir -p "$SCRIPTS_DIR"
        
        # 记录同步前的文件数
        prev_count=$(find "$TARGET_DIR" -name "*.json" 2>/dev/null | wc -l)
        
        # 创建临时目录进行克隆
        TEMP_DIR="temp_${{ matrix.bucket.name }}"
        git clone --depth 1 https://github.com/${{ matrix.bucket.repo }}.git "$TEMP_DIR"
        
        # 复制 bucket 目录下的 JSON 文件
        if [ -d "$TEMP_DIR/bucket" ]; then
          cp -r "$TEMP_DIR/bucket/"*.json "$TARGET_DIR/" 2>/dev/null || true
        fi
        
        # 复制 scripts 目录下的文件
        if [ -d "$TEMP_DIR/scripts" ]; then
          cp -r "$TEMP_DIR/scripts/"* "$SCRIPTS_DIR/" 2>/dev/null || true
        fi
        
        # 清理
        rm -rf "$TEMP_DIR"
        
        # 统计
        curr_count=$(find "$TARGET_DIR" -name "*.json" 2>/dev/null | wc -l)
        new_files=$((curr_count - prev_count))
        echo "同步完成。当前总数: $curr_count (新增: $new_files)"

    - name: 提交并推送更改
      if: github.event.inputs.bucket == '' || github.event.inputs.bucket == matrix.bucket.name
      run: |
        git add buckets/ scripts/
        if git diff --cached --quiet; then
          echo "没有检测到更改"
        else
          git commit -m "chore: 同步 ${{ matrix.bucket.name }} (${{ matrix.bucket.repo }}) - $(date '+%Y-%m-%d %H:%M:%S')"
          
          # 推送重试逻辑
          for i in {1..5}; do
            git pull --rebase origin main
            if git push origin main; then
              echo "成功推送更改"
              exit 0
            fi
            echo "推送失败，等待重试 ($i/5)..."
            sleep $((i * 2))
          done
          exit 1
        fi

  update-readme:
    needs: sync-buckets
    runs-on: ubuntu-latest
    steps:
    - name: 检出代码库
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0
        
    - name: 更新 README 统计信息
      run: |
        current_time=$(TZ=Asia/Shanghai date '+%Y年%m月%d日 %H:%M:%S')
        
        # 构建统计内容
        STATS_CONTENT="最后更新时间: $current_time\n\n## 统计信息\n\n### 已同步的仓库\n\n"
        TOTAL_APPS=0
        
        # 遍历 buckets 目录
        for dir in buckets/*/; do
          if [ -d "$dir" ]; then
            name=$(basename "$dir")
            count=$(find "$dir" -name "*.json" | wc -l)
            STATS_CONTENT="${STATS_CONTENT}- **$name**: $count 个应用程序\n"
            TOTAL_APPS=$((TOTAL_APPS + count))
          fi
        done
        
        STATS_CONTENT="${STATS_CONTENT}\n**总计**: $TOTAL_APPS 个应用程序\n\n## scoop 添加 scoop-ctf bucket\n\n\`\`\`bash\nscoop bucket add scoop-ctf https://github.com/scoop-ctf/scoop-ctf\n\`\`\`"
        
        # 生成新的 README (保留标题)
        echo "# scoop-ctf" > README.md
        echo -e "$STATS_CONTENT" >> README.md
        
    - name: 提交并推送 README
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add README.md
        if ! git diff --cached --quiet; then
          git commit -m "docs: 更新统计信息 ($(date '+%Y-%m-%d %H:%M:%S'))"
          
          # 推送重试逻辑
          for i in {1..5}; do
            git pull --rebase origin main
            if git push origin main; then
              echo "成功推送 README"
              exit 0
            fi
            echo "推送失败，等待重试 ($i/5)..."
            sleep $((i * 2))
          done
          exit 1
        fi
