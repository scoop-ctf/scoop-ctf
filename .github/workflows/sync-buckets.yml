name: 同步 Scoop CTF 仓库
          
          # 推送前先拉取最新更改，避免冲突
          git pull --rebase origin main || true
          
          # 尝试推送，如果失败则重试
          for i in {1..3}; do
            if git push origin main; then
              echo "成功推送 ${{ matrix.bucket.name }} 的更改"
              break
            else
              echo "推送失败，5秒后重试... (尝试 $i/3)"
              sleep 5
              git pull --rebase origin main || true
            fi
          done
        else
          echo "没有新的提交需要推送"
        fi
  update-readme:
    needs: sync-buckets
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码库
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0
        
    - name: 拉取最新更改
      run: git pull origin main
      
    - name: 更新 README 时间戳和统计信息
      run: |
        current_time=$(TZ=Asia/Shanghai date '+%Y年%m月%d日 %H:%M:%S')
        
        # 创建临时文件来重新生成 README
        cp README.md README_temp.md
        
        # 移除旧的统计信息部分（从"最后更新时间"到文件末尾）
        sed -i '/最后更新时间:/,$d' README_temp.md
        
        # 添加新的时间戳
        echo "最后更新时间: $current_time" >> README_temp.md
        echo "" >> README_temp.md
        
        # 添加新的统计信息
        echo "## 统计信息" >> README_temp.md
        echo "" >> README_temp.md
        
        total_apps=0
        total_scripts=$(find scripts -type f 2>/dev/null | wc -l)
        
        # 动态获取所有的 buckets
        echo "### 已同步的仓库" >> README_temp.md
        echo "" >> README_temp.md
        # 获取已同步的所有 buckets 名称
        for bucket in $(ls buckets); do
          if [ -d "buckets/$bucket" ]; then
            bucket_apps=$(find buckets/$bucket -name "*.json" | wc -l)
            
            # 统计对应仓库的脚本数量
            bucket_scripts=0
            for script in scripts/*; do
              if [ -f "$script" ]; then
                # 检查脚本是否与当前仓库相关
                script_name=$(basename "$script")
                if echo "$script_name" | grep -qi "$bucket"; then
                  bucket_scripts=$((bucket_scripts + 1))
                fi
              fi
            done
            
            # 获取源仓库地址
            bucket_repo=$(grep -E "^\s*- name: $bucket" <<< "${{ toJson(matrix.bucket) }}" | sed -E 's/.*repo:\s*([^\s]+).*/\1/')
            
            if [ "$bucket_apps" -gt 0 ]; then
              if [ "$bucket_scripts" -gt 0 ]; then
                # 动态添加每个仓库的统计信息
                echo "- **$bucket**: $bucket_apps 个应用程序 + $bucket_scripts 个脚本" >> README_temp.md
                # echo "  - 源仓库: [https://github.com/$bucket_repo](https://github.com/$bucket_repo)" >> README_temp.md
              else
                echo "- **$bucket**: $bucket_apps 个应用程序" >> README_temp.md
                # echo "  - 源仓库: [https://github.com/$bucket_repo](https://github.com/$bucket_repo)" >> README_temp.md
              fi
              total_apps=$((total_apps + bucket_apps))
            fi
          fi
        done
        echo "" >> README_temp.md
        
        echo "### 总计" >> README_temp.md
        echo "" >> README_temp.md
        echo "**应用程序总数**: $total_apps" >> README_temp.md
        echo "" >> README_temp.md
        echo "**脚本总数**: $total_scripts" >> README_temp.md
        echo "" >> README_temp.md
        
        # 添加同步时间信息
        # echo "### 同步信息" >> README_temp.md
        # echo "" >> README_temp.md
        # echo "- 每日自动同步: 北京时间 08:00 (UTC 00:00)" >> README_temp.md
        # echo "- 支持手动触发: 在 GitHub Actions 页面手动运行工作流" >> README_temp.md
        # echo "- 支持选择性同步: 可指定同步特定仓库" >> README_temp.md

        # scoop 添加 scoop-ctf bucket 信息
        echo "## scoop 添加 scoop-ctf bucket " >> README_temp.md
        echo '```bash' >> README_temp.md
        echo 'scoop bucket add scoop-ctf https://github.com/scoop-ctf/scoop-ctf' >> README_temp.md
        echo '```' >> README_temp.md

        # 替换原文件
        mv README_temp.md README.md
        
        echo "已更新 README，包含 $total_apps 个应用程序和 $total_scripts 个脚本"
    
    - name: 提交 README 更新
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add README.md
        if git diff --cached --quiet; then
          echo "README 没有更改"
        else
          git commit -m "更新 README，包含最新统计信息 - $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin main
        fi
