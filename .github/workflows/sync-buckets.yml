name: 同步 Scoop CTF 仓库

on:
  schedule:
    # 每天北京时间早上8点运行 (UTC时间0点)
    - cron: '0 0 * * *'
  workflow_dispatch:
    # 允许手动触发
    inputs:
      bucket:
        description: '指定要同步的仓库（留空表示同步所有）'
        required: false
        default: ''

env:
  TZ: Asia/Shanghai
  BUCKETS: '[{"name": "sec", "repo": "tldro/scoop-security"}, {"name": "ar", "repo": "arch3rPro/PST-Bucket"}, {"name": "ctftools", "repo": "kengwang/scoop-ctftools-bucket"}]'

jobs:
  sync-buckets:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1  # 一次只运行一个job，避免并发推送冲突
    steps:
      - name: 获取仓库配置
        id: set-buckets
        run: echo "::set-output name=buckets::${{ env.BUCKETS }}"

      - name: 同步仓库
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: 设置 Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
        
      - name: 执行同步操作
        run: |
          # 获取从步骤中传递的桶列表
          buckets="${{ steps.set-buckets.outputs.buckets }}"
          
          # 使用 jq 解析 JSON 数据并遍历每个 bucket
          echo "同步仓库配置: $buckets"
          
          # 使用 jq 解析 JSON 数据并遍历每个仓库配置
          for bucket in $(echo $buckets | jq -c '.[]'); do
            name=$(echo $bucket | jq -r '.name')
            repo=$(echo $bucket | jq -r '.repo')

            echo "同步仓库 $name ($repo)"
            
            # 克隆源代码库，执行文件同步
            mkdir -p temp_sync
            cd temp_sync
            git clone --filter=blob:none --sparse https://github.com/$repo.git source_repo
            cd source_repo
            git sparse-checkout set bucket scripts

            # 处理 bucket 目录
            if [ -d "bucket" ]; then
              echo "处理 $name 的 bucket 目录"
              # 执行同步 bucket 目录的操作（根据实际需要）
              mkdir -p ../../buckets/${name}
              find bucket -name "*.json" -exec cp {} ../../buckets/${name}/ \;
            fi

            # 处理 scripts 目录
            if [ -d "scripts" ]; then
              echo "处理 $name 的 scripts 目录"
              # 执行同步 scripts 目录的操作（根据实际需要）
              mkdir -p ../../scripts
              cp -r scripts/* ../../scripts/
            fi

            cd ../..
            rm -rf temp_sync
          done

      - name: 提交此仓库的更改
        run: |
          git add buckets/* scripts/
          
          # 检查是否有更改
          if git diff --cached --quiet; then
            echo "没有检测到更改"
          else
            echo "检测到更改，正在提交..."
            git commit -m "更新同步内容 ($(date '+%Y-%m-%d %H:%M:%S'))"
            echo "提交了更改"
          fi

      - name: 推送更改
        run: |
          if git log origin/main..HEAD --oneline | grep -q .; then
            echo "正在推送更改..."
            
            # 推送前先拉取最新更改，避免冲突
            git pull --rebase origin main || true
            
            # 尝试推送，如果失败则重试
            for i in {1..3}; do
              if git push origin main; then
                echo "成功推送更改"
                break
              else
                echo "推送失败，5秒后重试... (尝试 $i/3)"
                sleep 5
                git pull --rebase origin main || true
              fi
            done
          else
            echo "没有新的提交需要推送"
          fi

  update-readme:
    needs: sync-buckets
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码库
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0
        
      - name: 拉取最新更改
        run: git pull origin main
    
      - name: 更新 README 时间戳和统计信息
        run: |
          current_time=$(TZ=Asia/Shanghai date '+%Y年%m月%d日 %H:%M:%S')
          
          cp README.md README_temp.md
          
          sed -i '/最后更新时间:/,$d' README_temp.md
          
          echo "最后更新时间: $current_time" >> README_temp.md
          echo "" >> README_temp.md
          
          echo "## 统计信息" >> README_temp.md
          echo "" >> README_temp.md
          
          total_apps=0
          total_scripts=$(find scripts -type f 2>/dev/null | wc -l)
          
          echo "### 已同步的仓库" >> README_temp.md
          echo "" >> README_temp.md
          for bucket in $(ls buckets); do
            if [ -d "buckets/$bucket" ]; then
              bucket_apps=$(find buckets/$bucket -name "*.json" | wc -l)
              
              bucket_scripts=0
              for script in scripts/*; do
                if [ -f "$script" ]; then
                  script_name=$(basename "$script")
                  if echo "$script_name" | grep -qi "$bucket"; then
                    bucket_scripts=$((bucket_scripts + 1))
                  fi
                fi
              done
              
              bucket_repo=$(grep -E "^\s*- name: $bucket" <<< "${{ toJson(matrix.bucket) }}" | sed -E 's/.*repo:\s*([^\s]+).*/\1/')
              
              if [ "$bucket_apps" -gt 0 ]; then
                if [ "$bucket_scripts" -gt 0 ]; then
                  echo "- **$bucket**: $bucket_apps 个应用程序 + $bucket_scripts 个脚本" >> README_temp.md
                  echo "  - 源仓库: [https://github.com/$bucket_repo](https://github.com/$bucket_repo)" >> README_temp.md
                else
                  echo "- **$bucket**: $bucket_apps 个应用程序" >> README_temp.md
                  echo "  - 源仓库: [https://github.com/$bucket_repo](https://github.com/$bucket_repo)" >> README_temp.md
                fi
                total_apps=$((total_apps + bucket_apps))
              fi
            fi
          done
          echo "" >> README_temp.md
          
          echo "### 总计" >> README_temp.md
          echo "" >> README_temp.md
          echo "**应用程序总数**: $total_apps" >> README_temp.md
          echo "" >> README_temp.md
          echo "**脚本总数**: $total_scripts" >> README_temp.md
          echo "" >> README_temp.md
          
          echo "### 同步信息" >> README_temp.md
          echo "" >> README_temp.md
          echo "- 每日自动同步: 北京时间 08:00 (UTC 00:00)" >> README_temp.md
          echo "- 支持手动触发: 在 GitHub Actions 页面手动运行工作流" >> README_temp.md
          echo "- 支持选择性同步: 可指定同步特定仓库" >> README_temp.md
          
          mv README_temp.md README.md
          
          echo "已更新 README，包含 $total_apps 个应用程序和 $total_scripts 个脚本"
      
      - name: 提交 README 更新
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "README 没有更改"
          else
            git commit -m "更新 README，包含最新统计信息 - $(date '+%Y-%m-%d %H:%M:%S')"
            git push origin main
          fi
