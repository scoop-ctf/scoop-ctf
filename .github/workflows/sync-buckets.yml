name: 同步 Scoop CTF 仓库

on:
  schedule:
    # 每天北京时间早上8点运行 (UTC时间0点)
    - cron: '0 0 * * *'
  workflow_dispatch:
    # 允许手动触发
    inputs:
      bucket:
        description: '指定要同步的仓库（留空表示同步所有）'
        required: false
        default: ''

env:
  TZ: Asia/Shanghai

jobs:
  sync-buckets:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码库
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: 设置 Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
    - name: 安装必要工具
      run: |
        # 安装 yq (YAML 处理工具)
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod a+x /usr/local/bin/yq
        
        # 安装 jq (JSON 处理工具)
        sudo apt-get update
        sudo apt-get install -y jq
        
    - name: 检查 buckets.yml 配置
      id: check-config
      run: |
        if [ ! -f "buckets.yml" ]; then
          echo "错误: buckets.yml 配置文件不存在"
          echo "请创建 buckets.yml 文件"
          exit 1
        fi
        
        echo "buckets.yml 配置文件存在"
        
    - name: 解析并同步 buckets
      run: |
        # 读取手动输入的 bucket
        MANUAL_BUCKET="${{ github.event.inputs.bucket }}"
        echo "手动指定同步: ${MANUAL_BUCKET:-'所有仓库'}"
        
        # 读取启用的 buckets
        echo "读取 buckets.yml 配置..."
        
        # 获取启用的 buckets 数量
        BUCKET_COUNT=$(yq e '.buckets | length' buckets.yml)
        echo "找到 $BUCKET_COUNT 个仓库配置"
        
        # 循环处理每个 bucket
        for i in $(seq 0 $((BUCKET_COUNT - 1))); do
          # 获取 bucket 配置
          BUCKET_ENABLED=$(yq e ".buckets[$i].enabled // true" buckets.yml)
          
          # 如果未启用则跳过
          if [ "$BUCKET_ENABLED" = "false" ]; then
            echo "跳过索引 $i: 未启用"
            continue
          fi
          
          BUCKET_NAME=$(yq e ".buckets[$i].name" buckets.yml)
          BUCKET_REPO=$(yq e ".buckets[$i].repo" buckets.yml)
          
          if [ -z "$BUCKET_NAME" ] || [ -z "$BUCKET_REPO" ]; then
            echo "跳过索引 $i: 配置不完整"
            continue
          fi
          
          echo "处理仓库 $i: $BUCKET_NAME -> $BUCKET_REPO"
          
          # 如果手动指定了 bucket，检查是否匹配
          if [ -n "$MANUAL_BUCKET" ] && [ "$MANUAL_BUCKET" != "$BUCKET_NAME" ]; then
            echo "跳过 $BUCKET_NAME - 只同步 $MANUAL_BUCKET"
            continue
          fi
          
          # 开始同步这个 bucket
          echo "================================================================"
          echo "开始同步: $BUCKET_NAME ($BUCKET_REPO)"
          echo "================================================================"
          
          # 1. 检查现有文件
          if [ -d "buckets/$BUCKET_NAME" ]; then
            EXISTING_COUNT=$(find "buckets/$BUCKET_NAME" -name "*.json" 2>/dev/null | wc -l)
            echo "现有文件数: $EXISTING_COUNT"
          else
            echo "没有现有文件"
            mkdir -p "buckets/$BUCKET_NAME"
          fi
          
          # 2. 克隆源代码库
          echo "克隆源代码库..."
          
          # 创建临时目录
          TEMP_DIR="temp_sync_$BUCKET_NAME"
          mkdir -p "$TEMP_DIR"
          cd "$TEMP_DIR"
          
          # 克隆源仓库
          git clone --filter=blob:none --sparse "https://github.com/$BUCKET_REPO.git" source_repo
          cd source_repo
          
          # 设置 sparse checkout
          git sparse-checkout set bucket scripts
          
          # 统计和复制文件
          BUCKET_FILES=0
          SCRIPT_FILES=0
          
          # 3. 处理 bucket 目录
          if [ -d "bucket" ]; then
            BUCKET_FILES=$(find bucket -name "*.json" | wc -l)
            echo "找到 $BUCKET_FILES 个 JSON 文件"
            
            # 清空目标目录
            rm -f "../../../buckets/$BUCKET_NAME"/*.json 2>/dev/null || true
            
            # 复制所有 JSON 文件
            echo "复制 bucket 文件..."
            find bucket -name "*.json" -exec cp {} "../../../buckets/$BUCKET_NAME/" \;
            
            # 验证复制结果
            COPIED_FILES=$(find "../../../buckets/$BUCKET_NAME" -name "*.json" 2>/dev/null | wc -l)
            echo "成功复制 $COPIED_FILES 个 bucket 文件"
          else
            echo "源仓库中没有 bucket 目录"
          fi
          
          # 4. 处理 scripts 目录
          if [ -d "scripts" ]; then
            SCRIPT_FILES=$(find scripts -type f | wc -l)
            echo "找到 $SCRIPT_FILES 个脚本文件"
            
            # 创建目标目录
            mkdir -p "../../../scripts"
            
            # 复制所有脚本文件
            echo "复制脚本文件..."
            find scripts -type f -exec cp --parents {} "../../../scripts/" 2>/dev/null || true
            
            # 验证复制结果
            COPIED_SCRIPTS=$(find "../../../scripts" -type f 2>/dev/null | wc -l)
            echo "复制了脚本文件到 scripts/ 目录"
          else
            echo "源仓库中没有 scripts 目录"
          fi
          
          TOTAL_FILES=$((BUCKET_FILES + SCRIPT_FILES))
          echo "总文件数: $TOTAL_FILES ($BUCKET_FILES bucket + $SCRIPT_FILES scripts)"
          
          # 返回工作目录
          cd ../../..
          
          # 清理临时目录
          rm -rf "$TEMP_DIR"
          
          # 5. 提交更改
          echo "提交更改..."
          
          # 添加文件到 Git
          git add "buckets/$BUCKET_NAME/" scripts/
          
          # 检查是否有变化
          if git diff --cached --quiet; then
            echo "没有检测到更改"
          else
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            COMMIT_MSG="更新 $BUCKET_NAME - $TOTAL_FILES 个文件 ($BUCKET_FILES bucket + $SCRIPT_FILES scripts) ($TIMESTAMP)"
            
            git commit -m "$COMMIT_MSG"
            echo "提交了更改: $COMMIT_MSG"
          fi
          
          echo "完成同步: $BUCKET_NAME"
          echo ""
        done
        
    - name: 推送更改
      run: |
        # 检查是否有新提交
        if git log origin/main..HEAD --oneline | grep -q .; then
          echo "有新的提交需要推送"
          
          # 先拉取最新更改
          echo "拉取最新更改..."
          git pull --rebase origin main || true
          
          # 尝试推送
          for i in {1..3}; do
            echo "推送尝试 $i/3..."
            if git push origin main; then
              echo "推送成功"
              break
            else
              if [ $i -lt 3 ]; then
                echo "推送失败，5秒后重试..."
                sleep 5
                git pull --rebase origin main || true
              else
                echo "推送失败，已达到最大重试次数"
              fi
            fi
          done
        else
          echo "没有新的提交需要推送"
        fi
        
  update-readme:
    needs: sync-buckets
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码库
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0
        
    - name: 安装必要工具
      run: |
        # 安装 yq
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod a+x /usr/local/bin/yq
        
    - name: 拉取最新更改
      run: git pull origin main
    
    - name: 更新 README 时间戳和统计信息
      run: |
        CURRENT_TIME=$(TZ=Asia/Shanghai date '+%Y年%m月%d日 %H:%M:%S')
        
        # 创建临时文件
        cp README.md README_temp.md
        
        # 移除旧的统计信息部分
        sed -i '/最后更新时间:/,$d' README_temp.md
        
        # 添加新的时间戳
        echo "最后更新时间: $CURRENT_TIME" >> README_temp.md
        echo "" >> README_temp.md
        
        # 添加统计信息标题
        echo "## 统计信息" >> README_temp.md
        echo "" >> README_temp.md
        
        # 初始化统计
        TOTAL_APPS=0
        TOTAL_SCRIPTS=$(find scripts -type f 2>/dev/null | wc -l)
        
        echo "### 已同步的仓库" >> README_temp.md
        echo "" >> README_temp.md
        
        # 检查 buckets.yml 是否存在
        if [ ! -f "buckets.yml" ]; then
          echo "错误: buckets.yml 配置文件不存在" >> README_temp.md
          mv README_temp.md README.md
          exit 1
        fi
        
        # 读取 buckets 配置
        BUCKET_COUNT=$(yq e '.buckets | length' buckets.yml 2>/dev/null || echo "0")
        
        if [ "$BUCKET_COUNT" = "0" ]; then
          echo "暂无同步的仓库" >> README_temp.md
        else
          # 循环处理每个 bucket
          for i in $(seq 0 $((BUCKET_COUNT - 1))); do
            BUCKET_NAME=$(yq e ".buckets[$i].name" buckets.yml 2>/dev/null)
            BUCKET_REPO=$(yq e ".buckets[$i].repo" buckets.yml 2>/dev/null)
            BUCKET_ENABLED=$(yq e ".buckets[$i].enabled // true" buckets.yml 2>/dev/null)
            
            if [ "$BUCKET_ENABLED" = "false" ]; then
              continue
            fi
            
            if [ -n "$BUCKET_NAME" ] && [ -n "$BUCKET_REPO" ]; then
              # 统计应用程序数量
              if [ -d "buckets/$BUCKET_NAME" ]; then
                BUCKET_APPS=$(find "buckets/$BUCKET_NAME" -name "*.json" 2>/dev/null | wc -l)
                
                # 统计相关脚本数量
                BUCKET_SCRIPT_COUNT=0
                if [ -d "scripts" ]; then
                  for SCRIPT in scripts/*; do
                    if [ -f "$SCRIPT" ]; then
                      SCRIPT_NAME=$(basename "$SCRIPT")
                      if echo "$SCRIPT_NAME" | grep -iq "$BUCKET_NAME"; then
                        BUCKET_SCRIPT_COUNT=$((BUCKET_SCRIPT_COUNT + 1))
                      fi
                    fi
                  done
                fi
                
                if [ "$BUCKET_APPS" -gt 0 ]; then
                  if [ "$BUCKET_SCRIPT_COUNT" -gt 0 ]; then
                    echo "- **$BUCKET_NAME**: $BUCKET_APPS 个应用程序 + $BUCKET_SCRIPT_COUNT 个脚本" >> README_temp.md
                  else
                    echo "- **$BUCKET_NAME**: $BUCKET_APPS 个应用程序" >> README_temp.md
                  fi
                  echo "  - 源仓库: [$BUCKET_REPO](https://github.com/$BUCKET_REPO)" >> README_temp.md
                  
                  TOTAL_APPS=$((TOTAL_APPS + BUCKET_APPS))
                fi
              fi
            fi
          done
        fi
        
        echo "" >> README_temp.md
        
        # 添加总计
        echo "### 总计" >> README_temp.md
        echo "" >> README_temp.md
        echo "**应用程序总数**: $TOTAL_APPS" >> README_temp.md
        echo "" >> README_temp.md
        echo "**脚本总数**: $TOTAL_SCRIPTS" >> README_temp.md
        echo "" >> README_temp.md
        
        # 添加同步信息
        echo "### 同步信息" >> README_temp.md
        echo "" >> README_temp.md
        echo "- 每日自动同步: 北京时间 08:00 (UTC 00:00)" >> README_temp.md
        # echo "- 支持手动触发: 在 GitHub Actions 页面手动运行工作流" >> README_temp.md
        # echo "- 支持选择性同步: 可指定同步特定仓库" >> README_temp.md
        
        # 替换原文件
        mv README_temp.md README.md
        
        echo "已更新 README，包含 $TOTAL_APPS 个应用程序和 $TOTAL_SCRIPTS 个脚本"
    
    - name: 提交 README 更新
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add README.md
        if git diff --cached --quiet; then
          echo "README 没有更改"
        else
          git commit -m "更新 README，包含最新统计信息 - $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin main
        fi