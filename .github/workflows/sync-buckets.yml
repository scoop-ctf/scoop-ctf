name: åŒæ­¥ Scoop CTF ä»“åº“

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹è¿è¡Œ (UTCæ—¶é—´0ç‚¹)
    - cron: '0 0 * * *'
  push:
    # å½“å·¥ä½œæµæ–‡ä»¶æœ¬èº«è¢«ä¿®æ”¹æ—¶è§¦å‘
    paths:
      - '.github/workflows/sync-buckets.yml'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      bucket:
        description: 'æŒ‡å®šè¦åŒæ­¥çš„ä»“åº“ï¼ˆç•™ç©ºè¡¨ç¤ºåŒæ­¥æ‰€æœ‰ï¼‰'
        required: false
        default: ''

env:
  TZ: Asia/Shanghai

jobs:
  sync-buckets:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      max-parallel: 1  # ä¸€æ¬¡åªè¿è¡Œä¸€ä¸ªjobï¼Œé¿å…å¹¶å‘æ¨é€å†²çª
      matrix:
        bucket:
          - name: sec
            repo: tldro/scoop-security
          - name: ar
            repo: arch3rPro/PST-Bucket
          - name: ctftools
            repo: kengwang/scoop-ctftools-bucket
    
    steps:
    - name: æ£€å‡ºä»£ç åº“
      if: github.event.inputs.bucket == '' || github.event.inputs.bucket == matrix.bucket.name
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: è®¾ç½® Git
      if: github.event.inputs.bucket == '' || github.event.inputs.bucket == matrix.bucket.name
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"

    - name: åŒæ­¥ä»“åº“å†…å®¹
      if: github.event.inputs.bucket == '' || github.event.inputs.bucket == matrix.bucket.name
      run: |
        echo "æ­£åœ¨åŒæ­¥ ${{ matrix.bucket.name }} (repo: ${{ matrix.bucket.repo }})..."
        
        # åˆ›å»ºç›®æ ‡ç›®å½•
        TARGET_DIR="buckets/${{ matrix.bucket.name }}"
        SCRIPTS_DIR="scripts"
        mkdir -p "$TARGET_DIR"
        mkdir -p "$SCRIPTS_DIR"
        
        # è®°å½•åŒæ­¥å‰çš„æ–‡ä»¶æ•°
        prev_count=$(find "$TARGET_DIR" -name "*.json" 2>/dev/null | wc -l)
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•è¿›è¡Œå…‹éš†
        TEMP_DIR="temp_${{ matrix.bucket.name }}"
        git clone --depth 1 https://github.com/${{ matrix.bucket.repo }}.git "$TEMP_DIR"
        
        # å¤åˆ¶ bucket ç›®å½•ä¸‹çš„ JSON æ–‡ä»¶
        if [ -d "$TEMP_DIR/bucket" ]; then
          cp -r "$TEMP_DIR/bucket/"*.json "$TARGET_DIR/" 2>/dev/null || true
        fi
        
        # å¤åˆ¶ scripts ç›®å½•ä¸‹çš„æ–‡ä»¶
        if [ -d "$TEMP_DIR/scripts" ]; then
          cp -r "$TEMP_DIR/scripts/"* "$SCRIPTS_DIR/" 2>/dev/null || true
        fi
        
        # æ¸…ç†
        rm -rf "$TEMP_DIR"
        
        # ç»Ÿè®¡
        curr_count=$(find "$TARGET_DIR" -name "*.json" 2>/dev/null | wc -l)
        new_files=$((curr_count - prev_count))
        echo "åŒæ­¥å®Œæˆã€‚å½“å‰æ€»æ•°: $curr_count (æ–°å¢: $new_files)"

    - name: æäº¤å¹¶æ¨é€æ›´æ”¹
      if: github.event.inputs.bucket == '' || github.event.inputs.bucket == matrix.bucket.name
      run: |
        git add buckets/ scripts/
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
        else
          git commit -m "chore: åŒæ­¥ ${{ matrix.bucket.name }} (${{ matrix.bucket.repo }}) - $(date '+%Y-%m-%d %H:%M:%S')"
          
          # æ¨é€é‡è¯•é€»è¾‘
          for i in {1..5}; do
            git pull --rebase origin main
            if git push origin main; then
              echo "æˆåŠŸæ¨é€æ›´æ”¹"
              exit 0
            fi
            echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…é‡è¯• ($i/5)..."
            sleep $((i * 2))
          done
          exit 1
        fi

  update-readme:
    needs: sync-buckets
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0
        
    - name: æ›´æ–° README ç»Ÿè®¡ä¿¡æ¯
      run: |
        current_time=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
        
        # å®šä¹‰ä»“åº“æ˜ å°„ï¼ˆç”¨äºé“¾æ¥ï¼‰
        declare -A REPO_MAP
        REPO_MAP["sec"]="tldro/scoop-security"
        REPO_MAP["ar"]="arch3rPro/PST-Bucket"
        REPO_MAP["ctftools"]="kengwang/scoop-ctftools-bucket"

        # æ„å»º Header
        README_BODY="# ğŸ›¡ï¸ scoop-ctf\n\n"
        README_BODY="${README_BODY}[![GitHub Stars](https://img.shields.io/github/stars/scoop-ctf/scoop-ctf?style=flat-square)](https://github.com/scoop-ctf/scoop-ctf/stargazers) "
        README_BODY="${README_BODY}[![GitHub License](https://img.shields.io/github/license/scoop-ctf/scoop-ctf?style=flat-square)](LICENSE) "
        README_BODY="${README_BODY}[![Auto Sync](https://img.shields.io/badge/Auto%20Sync-Enabled-blue?style=flat-square&logo=github-actions)](.github/workflows/sync-buckets.yml)\n\n"
        
        README_BODY="${README_BODY}è¿™æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºå®‰å…¨ç ”ç©¶äººå‘˜å’Œ CTF ç©å®¶è®¾è®¡çš„ Scoop bucket é›†åˆï¼Œæ¯æ—¥ä»å¤šä¸ªé¡¶çº§å®‰å…¨ä»“åº“è‡ªåŠ¨åŒæ­¥æ›´æ–°ã€‚\n\n"
        
        # å®‰è£…æŒ‡å—
        README_BODY="${README_BODY}## ğŸš€ å¿«é€Ÿå¼€å§‹\n\n\`\`\`bash\n# æ·»åŠ  bucket\nscoop bucket add scoop-ctf https://github.com/scoop-ctf/scoop-ctf\n\n# æœç´¢å·¥å…· (ä¾‹å¦‚ fscan)\nscoop search fscan\n\n# å®‰è£…å·¥å…·\nscoop install scoop-ctf/fscan\n\`\`\`\n\n"
        
        # ç»Ÿè®¡è¡¨æ ¼
        README_BODY="${README_BODY}## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\n\n"
        README_BODY="${README_BODY}| ä»“åº“åç§° | æ¸…å•æ•°é‡ | æ¥æºä»“åº“ |\n"
        README_BODY="${README_BODY}| :--- | :--- | :--- |\n"
        
        TOTAL_APPS=0
        
        # éå†å­ç›®å½•å¹¶å¡«å……è¡¨æ ¼
        for dir in buckets/*/; do
          if [ -d "$dir" ]; then
            name=$(basename "$dir")
            count=$(find "$dir" -name "*.json" | wc -l)
            repo_path=${REPO_MAP[$name]}
            if [ -n "$repo_path" ]; then
              repo_link="[$repo_path](https://github.com/$repo_path)"
            else
              repo_link="æœ¬åœ°ç»´æŠ¤"
            fi
            README_BODY="${README_BODY}| **$name** | $count | $repo_link |\n"
            TOTAL_APPS=$((TOTAL_APPS + count))
          fi
        done
        
        README_BODY="${README_BODY}\n**ğŸ”¥ æ€»è®¡å·²åŒæ­¥ $TOTAL_APPS ä¸ªå®‰å…¨å·¥å…·**\n\n"
        README_BODY="${README_BODY}> [!NOTE]\n"
        README_BODY="${README_BODY}> æ•°æ®æœ€åæ›´æ–°äº: \`$current_time\`\n"
        
        # å†™å…¥æ–‡ä»¶
        echo -e "$README_BODY" > README.md
        
    - name: æäº¤å¹¶æ¨é€ README
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add README.md
        if ! git diff --cached --quiet; then
          git commit -m "docs: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ ($(date '+%Y-%m-%d %H:%M:%S'))"
          
          # æ¨é€é‡è¯•é€»è¾‘
          for i in {1..5}; do
            git pull --rebase origin main
            if git push origin main; then
              echo "æˆåŠŸæ¨é€ README"
              exit 0
            fi
            echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾…é‡è¯• ($i/5)..."
            sleep $((i * 2))
          done
          exit 1
        fi
